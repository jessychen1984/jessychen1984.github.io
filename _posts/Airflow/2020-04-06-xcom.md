---
title: "Airflowä¸­åˆ©ç”¨xcomå®ç°taské—´ä¿¡æ¯ä¼ é€’"
subtitle: "Using XCOM to realize data transfer between airflow tasks"
layout: post
author: "jessychen"
header-style: text
tags:
  - Airflow
  - CS
---

> XComs let tasks exchange messages, allowing more nuanced forms of control and shared state. The name is an abbreviation of â€œcross-communicationâ€.

Airflowä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œå¿…ç„¶éœ€è¦è§£å†³ä¸€ä¸ªé‡è¦é—®é¢˜ï¼š**å¦‚ä½•åœ¨å¤šä¸ªè°ƒåº¦ä»»åŠ¡ä¸­å®ç°ä¿¡æ¯å…±äº«ï¼Ÿ**å³æ€ä¹ˆæŠŠtask Aæ‰§è¡Œå¾—åˆ°çš„ç»“æœä¼ é€’ç»™task Bï¼Œè®©task Bå¯ä»¥åŸºäºtask Açš„ç»“æœè¿›è¡Œåç»­æ“ä½œã€‚XComå°±æ˜¯ç»™å‡ºçš„ç­”æ¡ˆã€‚

* [åŸºæœ¬åŸç†](#åŸºæœ¬åŸç†)
* [Pushå’ŒPull](#pushå’Œpull)
* [Operatorçš„do_xcom_pushå‚æ•°](#operatorçš„do_xcom_pushå‚æ•°)
* [ä¸templateç»“åˆä½¿ç”¨](#ä¸templateç»“åˆä½¿ç”¨)
* [æ€»ç»“](#æ€»ç»“)

### åŸºæœ¬åŸç†

XComæ˜¯"cross-communication"çš„ç¼©å†™ã€‚å®ƒè¢«è®¾è®¡äºç”¨æ¥åœ¨Airflow å„ä¸ªtaské—´è¿›è¡Œæ•°æ®å…±äº«ã€‚XComå±äºAirflowçš„modelï¼Œè§`airflow.models.xcom.XCom`ï¼ŒåŒ…å«ä¸‹é¢å‡ ä¸ªå­—æ®µï¼š

```python
__tablename__ = "xcom"
key = Column(String(512, **COLLATION_ARGS), primary_key=True)
value = Column(LargeBinary)
timestamp = Column(UtcDateTime, default=timezone.utcnow, nullable=False)
execution_date = Column(UtcDateTime, primary_key=True)
# source information
task_id = Column(String(ID_LEN, **COLLATION_ARGS), primary_key=True)
dag_id = Column(String(ID_LEN, **COLLATION_ARGS), primary_key=True)
```

ä»ä¸Šè¿°codeå®šä¹‰å¯ä»¥äº†è§£åˆ°ï¼ŒXComé‡Œçš„å†…å®¹å…¶å®æ˜¯å­˜åœ¨Airflow DBä¸­çš„`xcom`è¿™å¼ è¡¨é‡Œçš„ã€‚å¦‚æœé…ç½®äº†Airflow UIï¼Œå¯ä»¥å¾ˆæ–¹é¢çš„æŸ¥åˆ°å½“å‰XComé‡Œå­˜çš„æ‰€ä»¥å†…å®¹*ï¼ˆå…¥å£ä½äºAdmin->XComsï¼‰*ï¼š

![image-20200406113247869](/img/in-post/Airflow/xcom-ui.png)

è¡¨é‡Œçš„å­—æ®µä¸modelä¸­çš„å®šä¹‰ä¸€ä¸€å¯¹åº”ï¼Œå¾ˆå¥½ç†è§£ã€‚å…¶ä¸­*execution_date*æ˜¯taskå¼€å§‹æ‰§è¡Œçš„æ—¶é—´ï¼Œ*timestamp*é»˜è®¤æ˜¯è¿™æ¡è®°å½•ç”Ÿæˆçš„æ—¶é—´ã€‚å›¾ä¸Šçš„XComå­˜çš„æ˜¯å¯¹åº”çš„taskçš„è¿”å›å€¼(key="return_value", value=â€Successâ€œ)ã€‚å¦‚æœä½ çš„taskå®šä¹‰äº†å…¶ä»–ç±»å‹çš„è¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡`return_value`è¿™ä¸ªkeyæ¥è·å–ã€‚

å¦‚æ­¤ï¼Œæ˜¾è€Œæ˜“è§ï¼ŒXComçš„æœ¬è´¨å°±æ˜¯**æŠŠtaskéœ€è¦ä¼ é€’çš„ä¿¡æ¯ä»¥KVçš„å½¢å¼å­˜åˆ°DBä¸­**ï¼Œè€Œå…¶ä»–taskåˆ™å¯ä»¥ä»DBä¸­è·å–ã€‚ç”±äºXComæ˜¯å­˜åœ¨DBè€Œä¸æ˜¯å†…å­˜ä¸­ï¼Œè¿™ä¹Ÿè¯´æ˜äº†å¯¹äºå·²ç»æ‰§è¡Œå®Œçš„DAGï¼Œå¦‚æœé‡è·‘å…¶ä¸­æŸä¸ªtaskçš„è¯ä¾ç„¶å¯ä»¥è·å–åˆ°åŒæ¬¡DAGè¿è¡Œæ—¶å…¶ä»–taskä¼ é€’çš„å†…å®¹ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œå‘ç°ä»€ä¹ˆé—®é¢˜æ²¡ï¼Ÿæ²¡é”™ï¼Œç”±äºXComä¸ä¼šè‡ªå·±æ¸…ç†ï¼Œæ‰€ä»¥DBé‡Œçš„æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šğŸ™€ã€‚è¿™é‡Œæ¨èåœ¨æ¯æ¬¡DAGæ‰§è¡Œsuccessçš„æœ€ååŠ ä¸€ä¸ªclearçš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡åœ¨DAGä¸­åŠ ä¸€ä¸ª`on_success_callback`æ¥å®ç°ï¼Œå‚è€ƒcodeå¦‚ä¸‹ï¼Œè¯·æŒ‰å®é™…æƒ…å†µè°ƒæ•´filteræ¡ä»¶ï¼š

```python
from airflow.models import DAG
from airflow.utils.db import provide_session
from airflow.models import XCom

@provide_session
def cleanup_xcom(context, session=None):
    dag_id = context['ti']['dag_id']
    session.query(XCom).filter(XCom.dag_id == dag_id).delete()

dag = DAG( ...
    on_success_callback=cleanup_xcom,
)
```

### Pushå’ŒPull

ä¸‹é¢æ¥è®²è®²å¦‚ä½•å¾€XComä¸­æ·»åŠ å’Œè·å–è®°å½•ã€‚ä¸Šé¢å·²ç»è¯´äº†ï¼ŒXComå­˜å‚¨çš„æ˜¯KVå½¢å¼çš„æ•°æ®å¯¹ï¼ŒAirflowåŒ…è£…äº†`xcom_push`å’Œ`xcom_pull`ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œå­˜å–ï¼Œå®šä¹‰åœ¨`taskinstance.py`ä¸­ï¼š[source](https://github.com/apache/airflow/blob/master/airflow/models/taskinstance.py)

```python
def xcom_push(
            self,
            key: str,
            value: Any,
            execution_date: Optional[datetime] = None) -> None:
  
def xcom_pull(
            self,
            task_ids: Optional[Union[str, Iterable[str]]] = None,
            dag_id: Optional[str] = None,
            key: str = XCOM_RETURN_KEY,
            include_prior_dates: bool = False) -> Any:
```

å¦‚æœæ²¡æœ‰ç‰¹æ®Šçš„éœ€æ±‚ï¼Œæˆ‘ä»¬åªéœ€å…³æ³¨é‡Œé¢çš„`key`å’Œ`value`è¿™ä¸¤ä¸ªå‚æ•°å³å¯ã€‚å…¶ä»–å‚æ•°Airflowä¼šæ ¹æ®taskçš„ä¸Šä¸‹æ–‡è‡ªåŠ¨æ·»åŠ ã€‚çœ‹ä¸ª`PythonOperator`çš„ä¾‹å­æ›´èƒ½è¯´æ˜ï¼š

```python
def push_data(**context):
  context['ti'].xcom_push(key='test_key', value='test_val')
  
push_data_op = PythonOperator(
    task_id = 'push_data',
    python_callable = push_data,
    provide_context=True,
    dag = dag
)

def pull_data(**context):
  test_data = context['ti'].xcom_pull(key='test_key')
  
pull_data_op = PythonOperator(
    task_id = 'pull_data',
    python_callable = pull_data,
    provide_context=True,
    dag = dag
)

push_data_op >> pull_data_op
```

ä¸Šé¢çš„codeå°±åœ¨`push_data`å’Œ`pull_data`ä¸¤ä¸ªä»»åŠ¡ä¸­ä¼ é€’äº†`key='test_key', value='test_val'`è¿™ä¸€æ¡æ•°æ®ã€‚æ›´æ–¹ä¾¿çš„æ˜¯ï¼Œè¿™é‡Œçš„valueä¸ä»…é™äºstrç±»å‹ï¼Œè¿™å°±æä¾›äº†æ›´å¤§çš„è‡ªç”±åº¦ã€‚æ³¨æ„ï¼Œåœ¨opreatorä¸­å¿…é¡»è¦æœ‰`provide_context=True,`æ‰èƒ½åœ¨operatorå†…éƒ¨é€šè¿‡`context['ti']`ï¼ˆæœ‰çš„æ–‡æ¡£ç»™çš„ä¾‹å­æ˜¯`context['task_instance']`ï¼‰è·å¾—å½“å‰taskçš„TaskInstanceï¼Œè¿›è¡ŒXCom push/pullçš„ç›¸å…³æ“ä½œã€‚

æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªtaskè¿”å›ä¸€ä¸ªå€¼ï¼ˆä»operatorçš„execute()æ–¹æ³•ï¼Œæˆ–è€…ä»PythonOperatorçš„python_callableæŒ‡å®šçš„æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆåŒ…å«è¯¥å€¼çš„XComå°†è¢«è‡ªåŠ¨pushï¼Œé»˜è®¤çš„keyå°±æ˜¯ä¸Šé¢è§è¿‡çš„`return_value`ã€‚å®˜æ–¹æ–‡æ¡£ä¸­ç»™äº†ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œè¿™é‡Œå¯ä»¥ä¸æŒ‡å®škeyï¼š

```python
# inside a PythonOperator called 'pushing_task'
def push_function():
    return value

# inside another PythonOperator where provide_context=True
def pull_function(**context):
    value = context['ti'].xcom_pull(task_ids='pushing_task')
```

å¾ˆå¥½ç†è§£ï¼Œè¿™ä¸ªä¾‹å­æ˜¯é€šè¿‡ä¼ é€’`task_ids`å‚æ•°æ¥è·å–å¯¹åº”taskçš„è¿”å›å€¼ã€‚è¿™é‡Œçš„`task_ids`å¦‚æœä¼ é€’å¤šä¸ªï¼Œåˆ™è¿”å›ç›¸åº”tasksçš„XComå€¼åˆ—è¡¨ã€‚å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥åŒæ—¶æŒ‡å®š`key`å‚æ•°ï¼Œæ¥è·å–æŒ‡å®štasksé‡Œxcom_pushçš„keyå¯¹åº”çš„valueã€‚

### Operatorçš„do_xcom_pushå‚æ•°

çœ‹å®Œä¸Šé¢è¿™äº›ï¼Œä½ åº”è¯¥å¯¹XComçš„ä½¿ç”¨æœ‰äº†åˆæ­¥çš„äº†è§£ã€‚å¯èƒ½åˆä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼šAirflowæä¾›äº†ä¸å°‘é¢„å®šä¹‰çš„Operatorï¼Œæ–¹ä¾¿æˆ‘ä»¬ç›´æ¥è°ƒç”¨æ¥å®Œæˆä¸€äº›åŸºæœ¬çš„taskï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šå»æ”¹é‡Œé¢çš„å†…å®¹ã€‚é‚£ä¹ˆè¦æ€æ ·è·å–è¿™ç±»taskçš„è¾“å‡ºå‘¢ï¼Ÿè¿™å°±æ˜¯è¿™èŠ‚è¦è®²çš„å†…å®¹äº†ã€‚

åœ¨`BaseOperator`ä¸­æä¾›äº†ä¸€ä¸ª`do_xcom_push`å‚æ•°ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```python
:param do_xcom_push: if True, an XCom is pushed containing the Operator's
    result
:type do_xcom_push: bool
......
do_xcom_push: bool = True,
```

åœ¨Operatorå®ç°ä¸­å¯ä»¥ç”¨è¿™ä¸ªå‚æ•°æ¥å†³å®šæ˜¯å¦å¾€XComä¼ é€’ä¸€äº›éœ€è¦çš„ä¿¡æ¯ï¼ŒBaseOperatorä¸­é»˜è®¤å€¼æ˜¯Trueã€‚æ‰¾äº†ä¸ª`DatabricksSubmitRunOperator`ä½œä¸ºå®ç°çš„ä¾‹å­ï¼š

```python
#param do_xcom_push: Whether we should push run_id and run_page_url to xcom.
class DatabricksSubmitRunOperator(BaseOperator):
	@apply_defaults
  	def __init__(
        ......
			do_xcom_push=False,
        ......
  	):
      self.do_xcom_push = do_xcom_push
       
    def execute(self, context):
    	hook = self._get_hook()
      self.run_id = hook.run_now(self.json)
      _handle_databricks_operator_execution(self, hook, self.log, context)

XCOM_RUN_ID_KEY = 'run_id'
XCOM_RUN_PAGE_URL_KEY = 'run_page_url'

def _handle_databricks_operator_execution(operator, hook, log, context):
	if operator.do_xcom_push:
		context['ti'].xcom_push(key=XCOM_RUN_ID_KEY, value=operator.run_id)
  log.info('Run submitted with run_id: %s', operator.run_id)
  run_page_url = hook.get_run_page_url(operator.run_id)
  if operator.do_xcom_push:
  	context['ti'].xcom_push(key=XCOM_RUN_PAGE_URL_KEY, value=run_page_url)
  log.info('View run status, Spark UI, and logs at %s', run_page_url)
```

`do_xcom_push`åœ¨è¿™é‡Œå·²ç»è¢«é»˜è®¤ç½®æˆäº†Falseï¼Œæ˜¯å› ä¸ºOperatorä¸ç¡®å®šå…¶ä»–taskæ˜¯å¦ä¸€å®šéœ€è¦ç›¸å…³å†…å®¹ï¼Œç½®æˆFalseå¯ä»¥ä¸å¾€XComä¼ å¤šä½™çš„ä¸œè¥¿ã€‚å½“taskç”¨Operatoråˆå§‹åŒ–æ—¶æ˜¾ç¤ºæŒ‡å®š`do_xcom_push=True`æ—¶ï¼Œåœ¨æ‰§è¡Œæ—¶ä¾¿ä¼šæŠŠ`run_id`å’Œ`run_page_url`pushç»™XComï¼Œåé¢çš„taskä¹Ÿå¯ä»¥è¯»åˆ°å¯¹åº”çš„å€¼ã€‚

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡`retrun value`çš„å½¢å¼æ¥å†™å…¥XComï¼Œä¾‹å¦‚`SSHOperator`å’Œ`BashOperator`çš„å®ç°ã€‚*ï¼ˆBashOperatoråœ¨ä¹‹å‰ç‰ˆæœ¬ä¼ çš„æ˜¯è‡ªå®šä¹‰çš„`xcom_push`å‚æ•°æ¥ä½œä¸ºæ ‡å¿—ï¼Œæ–°codeå·²ç»ç»Ÿä¸€æ”¹äº†ã€‚ä½†æˆ‘çœ‹ç°åœ¨airflow masterä¸Šçš„codeï¼Œè¿™ä¸¤ä¸ªoperatoréƒ½æ²¡æœ‰å¯¹do_xcom_pushè¿›è¡Œåˆ¤æ–­ï¼Œè€Œæ˜¯ç›´æ¥retrun valueäº†ã€‚ï¼‰*

### ä¸templateç»“åˆä½¿ç”¨

ä¸Šé¢æåˆ°çš„XComçš„è·å–éƒ½æ˜¯åœ¨Operatorå†…éƒ¨è°ƒç”¨xcom_pullã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘è¦åœ¨åˆ›å»ºtaskçš„æ—¶å€™å°±è·å¾—è¿™ä¸ªå€¼ä½œä¸ºtaskçš„åˆå§‹å‚æ•°ä¼ é€’è¿›å»ï¼Œæœ‰æ²¡æœ‰å¯èƒ½åŠåˆ°å‘¢ï¼Ÿè¿™åœ¨ç»™ä¸€äº›é¢„å®šä¹‰çš„Operatorä¼ é€’å‚æ•°æ˜¯å°¤å…¶éœ€è¦ã€‚ç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ã€‚

æƒ³åœ¨taskå¤–éƒ¨è·å–xcomé‡Œçš„å€¼ï¼Œå¯ä»¥ç”¨templateæ¥å®ç°ï¼Œç»™ä¸ªBashOperatorçš„ä¾‹å­ï¼š

```python
bash_op = BashOperator(
    task_id='xcom_pull_by_template',
    bash_command={% raw %}'echo "{{ ti.xcom_pull(task_ids="push_task", key="push_key") }}"'{% endraw %},
    dag=dag
)
```

{% raw %}ä½¿ç”¨template `{{ ti.xcom_pull(...) }}`å¯ä»¥è¾¾åˆ°ç›®çš„ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`{{ *** }}`å¿…é¡»åŒ…å«åœ¨å¼•å·å†…æ‰ç”Ÿæ•ˆã€‚ç›´æ¥ä½¿ç”¨æ˜¯ä¼šæŠ¥é”™çš„ã€‚å†çœ‹ä¸‹Airflowä½¿ç”¨çš„`jinja template`çš„ä»‹ç»ï¼š{% endraw %}

> A jinja template is simply a text file that contains the following:
>
> - **variables** and/or **expressions** - these get replaced with values when a template is rendered.
> - **tags** - these control the logic of the template.
>
> Jinja templating allows you to defer the rendering of **strings** in your tasks until the actual running of those tasks.
>

å°±æ˜¯è¯´ï¼Œtemplateåšçš„æ˜¯ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼Œè€Œä¸å…³å¿ƒvalueçš„å®é™…æ•°æ®ç±»å‹ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ˜¯ä½ æƒ³ä¼ çš„æ˜¯æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç±»å‹çš„è¯ï¼Œtemplateæ˜¯ä¸ä¼šå¤„ç†çš„ã€‚è¿™é‡Œï¼Œå»ºè®®å¯ä»¥å¾€XComé‡Œåˆ†åˆ«å¤šæ¬¡pushï¼Œåœ¨å¤–éƒ¨å†æ„é€ æˆéœ€è¦çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œè¦å¾€`DatabricksSubmitRunOperator`ä¼ ä¸€ä¸ªjsonç±»å‹çš„å‚æ•°ï¼Œå¯ä»¥è¿™æ ·ï¼š

```python
{% raw %}databricks_op = DatabricksSubmitRunOperator(
  task_id = "databricks_task",
  json = {
    "new_cluster":{
      "node_type_id": '{{ ti.xcom_pull(key="node_type") }}',
      "autoscale":{
        "min_workers": 1,
         "max_workers": '{{ ti.xcom_pull(key="instance_count") }}'
       }
    },
    "libraries" : [
      {
        "jar": '{{ ti.xcom_pull(key="jar") }}'
      }
    ]
  }
){% endraw %}
```

### æ€»ç»“

æœ€åï¼Œå¯¹XComçš„ä½¿ç”¨åšä¸‹æ€»ç»“ï¼š

1. XComç”¨æ¥åœ¨Airflow å„ä¸ªtaské—´è¿›è¡Œæ•°æ®å…±äº«
2. XComé€šè¿‡æŠŠtaskéœ€è¦ä¼ é€’çš„ä¿¡æ¯ä»¥KVçš„å½¢å¼å­˜åˆ°DBä¸­æ¥å®ç°æ•°æ®å…±äº«
3. å¯ä»¥é€šè¿‡TaskInstanceçš„xcom_pushå’Œxcom_pushæ¥å­˜å–æ•°æ®
4. æœ‰äº›é¢„å®šä¹‰çš„Operatoré€šè¿‡do_xcom_pushå˜é‡åˆ¤æ–­æ˜¯å¦å¾€XComå­˜ç»“æœ
5. åœ¨taskå¤–éƒ¨å¯ä»¥é€šè¿‡templateçš„æ–¹å¼è·å–XComé‡Œçš„å€¼

