<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="https://jessychen1984.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://jessychen1984.github.io/" rel="alternate" type="text/html" /><updated>2020-03-24T08:27:40+08:00</updated><id>https://jessychen1984.github.io/feed.xml</id><title type="html">KiwiJia Blog</title><subtitle>This is KiwiJia's blog</subtitle><entry><title type="html">MiniProjä¹‹ç®€å•è®¡ç®—é¢˜å‡ºé¢˜å™¨</title><link href="https://jessychen1984.github.io/2020/03/23/calculate-generator/" rel="alternate" type="text/html" title="MiniProjä¹‹ç®€å•è®¡ç®—é¢˜å‡ºé¢˜å™¨" /><published>2020-03-23T00:00:00+08:00</published><updated>2020-03-23T00:00:00+08:00</updated><id>https://jessychen1984.github.io/2020/03/23/calculate-generator</id><content type="html" xml:base="https://jessychen1984.github.io/2020/03/23/calculate-generator/">æœ€è¿‘ï¼Œå®¶æœ‰å°å„¿åˆé•¿æˆã€‚æ›¾ç»èŒèŒå“’çš„Samå°ç›†å‹ä¹Ÿé©¬ä¸Šè¦æ­¥å…¥å°å­¦ç”Ÿçš„è¡Œåˆ—äº†ã€‚ä¸ºäº†ä¸è¾“åœ¨èµ·è·‘çº¿ä¸Šï¼Œè€æ¯äº²å†³å®šæ¯å¤©ç»™å‡º100é¢˜è®¡ç®—é¢˜ğŸ˜ã€‚æ‰‹åŠ¨å‡ºé¢˜å¤ªéº»çƒ¦ï¼Œè‚¿ä¹ˆåŠï¼Ÿå½“ç„¶æ˜¯åŠ¨æ‰‹å†™ä¸€ä¸ªäº†ï¼ç”¨ä¸Šä¼Ÿå¤§çš„**Python**ï¼Œåˆ†åˆ†é’Ÿæå®šä¸åœ¨è¯ä¸‹ï¼š

```python
'''
A simple python calculation question generator
usg: python calculator.py -d &quot;+,-&quot; -c 3 -l 200 -t 100
usg: python calculator.py --op_type=&quot;+,-&quot; --op_count=3 --limit=20 --total=100
'''
import sys, getopt, random

def auto_cal_generator(limit=100, op_count=1, op_type=[&quot;+&quot;], total=100):
    print(&quot;Here are today's %d works, good luck!&quot; % total)
    l = len(op_type)-1
    for j in range(0, total):
        up = limit
        question = &quot;&quot;
        for i in range(0, op_count+1):
            num = random.randint(1,max(1,min(limit,up))) 
            if i == 0:
                question = &quot;%s%d&quot; % (question, num)
                up -= num
                continue
            op_i = random.randint(0,l)
            op = op_type[op_i]
            question = &quot;%s%s%d&quot; % (question, op, num)
            if op ==&quot;+&quot;:
                up -= num
            elif op == &quot;-&quot;:
                up += num
            else:
                print(&quot;operator error: %s&quot; % op)
                sys.exit(1)
        
        print(&quot;%d: %s=&quot; % (j+1, question))

def main(argv=None):
    if argv is None:
        argv = sys.argv
    opts, _dummy = getopt.getopt( sys.argv[1:], &quot;l:c:d:t:&quot;, [&quot;limit=&quot;,&quot;op_count=&quot;,&quot;op_type=&quot;,&quot;total=&quot;])
    limit = 100
    op_count = 1
    op_type = [&quot;+&quot;]
    total = 100
    
    for opt,arg in opts:
        if opt in [&quot;-l&quot;, &quot;--limit&quot;]:
            limit = int(arg)
        elif opt in [&quot;-c&quot;, &quot;--op_count&quot;]:
            op_count = int(arg)
        elif opt in [&quot;-d&quot;, &quot;--op_type&quot;]:
            op_type = arg.strip().split(&quot;,&quot;)
        elif opt in [&quot;-t&quot;, &quot;--total&quot;]:
            total = int(arg)

    auto_cal_generator(limit, op_count, op_type, total)

if __name__ == '__main__':
    main()  
```

æœ‰äº†è¿™ä¸ªç¥å™¨åï¼Œæƒ³çœ‹ç”µè§†ï¼Ÿæƒ³åƒå†°æ¿€å‡Œï¼Ÿæƒ³å»æ¸¸ä¹å›­ï¼Ÿå…ˆåš30é¢˜è§£é”ï¼Œç”¨æ³•ï¼š

```shell
#å‡º30é¢˜200ä»¥å†…3ä¸ªè¿ç®—ç¬¦çš„åŠ å‡æ³•è®¡ç®—
python calculator.py -d &quot;+,-&quot; -c 3 -l 200 -t 30
```

çœ‹çœ‹ç»“æœï¼š

![auto_cal_q](/img/in-post/MiniProj/auto_cal_q.png)

å½“ç„¶ï¼Œå¯¹äºä¸åˆ°ä¸€å¹´çº§çš„å°è±†åŒ…æ¥è¯´ï¼Œç”¨åŠ å‡æ³•å¯¹ä»˜å·²ç»æˆ³æˆ³æœ‰ä½™äº†ï¼Œä¹˜é™¤æ³•ç­‰æœ‰ç©ºå†åŠ å§ã€‚

é¡¹ç›®ä»£ç [ç‚¹æ­¤](https://github.com/jessychen1984/MiniProj/blob/master/src/misc/calculator.py)ä¸‹è½½</content><author><name>jessychen</name></author><category term="Python" /><category term="CS" /><category term="MiniProj" /><summary type="html">æœ€è¿‘ï¼Œå®¶æœ‰å°å„¿åˆé•¿æˆã€‚æ›¾ç»èŒèŒå“’çš„Samå°ç›†å‹ä¹Ÿé©¬ä¸Šè¦æ­¥å…¥å°å­¦ç”Ÿçš„è¡Œåˆ—äº†ã€‚ä¸ºäº†ä¸è¾“åœ¨èµ·è·‘çº¿ä¸Šï¼Œè€æ¯äº²å†³å®šæ¯å¤©ç»™å‡º100é¢˜è®¡ç®—é¢˜ğŸ˜ã€‚æ‰‹åŠ¨å‡ºé¢˜å¤ªéº»çƒ¦ï¼Œè‚¿ä¹ˆåŠï¼Ÿå½“ç„¶æ˜¯åŠ¨æ‰‹å†™ä¸€ä¸ªäº†ï¼ç”¨ä¸Šä¼Ÿå¤§çš„Pythonï¼Œåˆ†åˆ†é’Ÿæå®šä¸åœ¨è¯ä¸‹ï¼š</summary></entry><entry><title type="html">Airflowä¸­çš„è·¯å¾„é€‰æ‹©</title><link href="https://jessychen1984.github.io/2020/03/22/python-branch/" rel="alternate" type="text/html" title="Airflowä¸­çš„è·¯å¾„é€‰æ‹©" /><published>2020-03-22T00:00:00+08:00</published><updated>2020-03-22T00:00:00+08:00</updated><id>https://jessychen1984.github.io/2020/03/22/python-branch</id><content type="html" xml:base="https://jessychen1984.github.io/2020/03/22/python-branch/">&gt; Airflow æ˜¯ Airbnb å…¬å¸å¼€æºçš„ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ, é€šè¿‡ä½¿ç”¨ Python å¼€å‘ DAG, éå¸¸æ–¹ä¾¿çš„è°ƒåº¦è®¡ç®—ä»»åŠ¡ã€‚

Airflowä¹‹å‰ï¼Œå½“å¤šä¸ªä¸Šä¸‹æ¸¸çš„ä»»åŠ¡é—´å­˜åœ¨ä¾èµ–æ—¶ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ¥å†™ä¸€äº›è°ƒåº¦çš„codeï¼Œå¸¸ç”¨çš„æœ‰å‡ ç§ï¼š

* ä¸Šæ¸¸ä»»åŠ¡å®Œæˆåç½®ä¸ªdoneæ ‡è®°ã€‚éœ€è¦ä¸‹æ¸¸éš”æ®µæ—¶é—´æ£€æŸ¥ä¸Šæ¸¸ä»»åŠ¡æœ‰æ²¡æœ‰å®Œæˆã€‚
* ä¸Šæ¸¸å®Œæˆä»»åŠ¡åé€šè¿‡æŸä¸ªapiæ¥callä¸‹æ¸¸ã€‚ä½ è¯´call å¤±è´¥äº†ï¼Ÿretryå¤§æ³•ç”¨èµ·æ¥å‘€â€‹â€‹ã€‚ã€‚ã€‚

æ¨¡å—å¤ªå¤šï¼Œä¾èµ–å¤ªå¤æ‚ï¼Œè®°ä¸ä½æ€ä¹ˆåŠï¼Ÿå†™ä¸ªæ–‡æ¡£å§ã€‚ã€‚ã€‚ä¸Šæ¸¸æ”¹äº†ï¼Ÿï¼Ÿæ”¹æ–‡æ¡£å§ã€‚ã€‚ã€‚ä¸‹æ¸¸åˆå˜äº†ï¼Ÿï¼Ÿï¼Ÿå†æ”¹ã€‚ã€‚ã€‚å“å‘€ï¼Œä¸Šçº¿æ¥ä¸åŠäº†ï¼Œè¿‡å‡ å¤©æ›´æ–°å§ã€‚ã€‚ã€‚ã€‚é‚£ä¸ªæ–‡æ¡£å¾ˆä¹…æ²¡æ›´æ–°äº†ï¼Œè¿˜æ˜¯çœ‹codeå§ã€‚ã€‚ã€‚

è€ŒAirflowä½¿ç”¨DAGï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡å®šä¹‰**Operator**ï¼ŒåŠOperatoré—´çš„å…³ç³»ï¼ˆ**upstream, downstream**ï¼‰æ¥è§£å†³ä»»åŠ¡ä¹‹é—´çš„å„ç§ä¾èµ–ã€‚åŒæ—¶ï¼Œå®ƒè¿˜æä¾›äº†UIæ¥æŸ¥çœ‹ä»»åŠ¡ä¾èµ–çš„DAGï¼Œä»»åŠ¡è¿è¡ŒçŠ¶æ€ã€‚ç®€å•çš„è¯´ï¼Œå®ƒå¯ä»¥ä½¿æˆ‘ä»¬æ›´å¤šçš„å…³æ³¨åˆ°ä¸šåŠ¡çš„å®ç°ä¸Šè€Œä¸æ˜¯å„ç§å¤æ‚çš„æ¨¡å—è°ƒç”¨åŠç¹ççš„æ–‡æ¡£ç»´æŠ¤ã€‚

å½“ç„¶ï¼Œä½œä¸ºä¸€æ¡å®Œæ•´çš„ä¸šåŠ¡æµï¼Œæ ¹æ®ä¸Šæ¸¸çš„æ‰§è¡Œç»“æœæ¥å†³å®šä¸‹æ¸¸çš„è¡Œä¸ºæ˜¯æœ€å¸¸è§ä¸è¿‡çš„äº‹äº†ã€‚æ¯”å¦‚ğŸ‘‡çš„ä¾‹å­ï¼š

æœ‰ä¸ªæ·˜æ°”çš„Samå°ç›†å‹ï¼Œæ¯å¤©æŒ‰æ—¶ **å®Œæˆä½œä¸š** æ˜¯ä¸ªå¤§éš¾é¢˜ã€‚äºæ˜¯ï¼Œå¦ˆå¦ˆæƒ³äº†ä¸ªåŠæ³•ï¼š

![branch-dag](/img/in-post/Airflow/branch.png)

çœŸæ˜¯ä¸ªä¸é”™çš„æ³•å­ğŸ‘ï¼è¿™é‡Œï¼Œ`8ç‚¹å‰å†™å®Œ`åœ¨Airflowé‡Œå°±æ˜¯ä¸ªåˆ¤æ–­ç”¨çš„taskï¼Œç”±å®ƒæ¥å†³å®šæ•´ä¸ªDAGçš„ä¸‹ä¸€æ­¥æ“ä½œã€‚é‚£ä¹ˆï¼Œæ€ä¹ˆå®ç°å‘¢ï¼ŸAirflowæä¾›äº†**BranchPythonOperator**ï¼Œç”¨æ¥æ”¯æŒåˆ†æ”¯, é€šè¿‡å‡½æ•°è¿”å›è¦æ‰§è¡Œçš„åˆ†æ”¯ã€‚

```python
check_hour_op = BranchPythonOperator(
  task_id = &quot;check_hour&quot;,
  python_callable = check_hour,
  dag = dag
)
def check_hour(){
  if current_hour &gt; 8:
    return &quot;sleep&quot;
  else:
    return &quot;watch_animation&quot;
}
do_homework_op &gt;&gt; check_hour_op &gt;&gt; [watch_animation_op, sleep_op]
watch_animation_op &gt;&gt; sleep_op
```

OkğŸ‘ ç®€ç›´å¤ªç®€å•äº†ï¼æ‰§è¡Œä¸€ä¸‹è¯•è¯•ï¼Œç„¶åä½ ä¼šå‘ç°ï¼Œå½“`check_hour`è¿”å›`watch_animation`æ—¶ï¼Œ`sleep`è¿™ä¸ªtaskçš„çŠ¶æ€æ°¸è¿œæ˜¯skipçš„ï¼Ÿï¼Ÿï¼Ÿè®©æˆ‘ä»¬ç¿»ä¸€ä¸‹å®˜æ–¹çš„è§£é‡Šï¼š

&gt; Note that using tasks with `depends_on_past=True` downstream from `BranchPythonOperator` is logically unsound as `skipped` status will invariably lead to block tasks that depend on their past successes. `skipped` states propagates where all directly upstream tasks are `skipped`.

å°±æ˜¯è¯´ï¼Œ`sleep`è¿™ä¸ªtaskåœ¨`check_hour`é€‰æ‹©äº†`watch_animation`çš„æ—¶å€™å°±è¢«skipæ‰äº†ï¼Œå³ä¾¿è¿™é‡Œå®ƒæ˜¯`watch_animation`çš„ä¸‹æ¸¸ä»»åŠ¡ï¼Œä»ç„¶ä¸ä¼šè¢«æ‰§è¡ŒğŸ˜­ã€‚åŸå› å‘¢ï¼Ÿå®˜æ–¹è¯´æ˜¯downstreamè®¾äº†*depends_on_past=True*ã€‚è¦çŸ¥é“ï¼Œoperatorä¸­è¿˜æœ‰ä¸ªå±æ€§å«*trigger_rule*ï¼Œé»˜è®¤å€¼æ˜¯*all_success*ã€‚è¿™ä¸¤ä¸ªç»„åˆåœ¨ä¸€èµ·å°±è¦ä¸Šæ¸¸çš„taskçŠ¶æ€éƒ½ä¸º*success*æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚è€Œè¿™é‡Œ`sleep`çš„ä¸Šæ¸¸ä»»åŠ¡`watch_animation`çŠ¶æ€æ˜¯*skipped*, æ‰€ä»¥`sleep`å°±æ²¡æœ‰è¢«æ‰§è¡Œåˆ°äº†ã€‚é‚£ä¹ˆï¼Œå¦‚æœè¿™é‡Œæˆ‘ä»¬æŠŠ`sleep`çš„*trigger_rule*ç½®æˆ*none_failed*çš„è¯ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±èƒ½æŒ‰æˆ‘ä»¬é¢„æœŸçš„æ‰§è¡Œä¸‹å»äº†:

```python
sleep_op = PythonOperator(
  task_id = &quot;sleep&quot;,
  trigger_rule = &quot;none_failed&quot;,
  python_callable = &quot;sleep&quot;,
  dag = dag
)
```

å†è¯•ä¸€ä¸‹ï¼Œæœç„¶å¯ä»¥å•¦:satisfied:

Airflowç°åœ¨æ”¯æŒçš„Trigger Rules:

&gt; ALL_SUCCESS = 'all_success'
&gt; ALL_FAILED = 'all_failed' 
&gt; ALL_DONE = 'all_done' 
&gt; ONE_SUCCESS = 'one_success' 
&gt; ONE_FAILED = 'one_failed' 
&gt; NONE_FAILED = 'none_failed' 
&gt; NONE_SKIPPED = 'none_skipped' 
&gt; DUMMY = 'dummy'

é™¤äº†ä¸Šé¢è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨**DummyOperator**æ¥è¾¾åˆ°æƒ³è¦çš„æ•ˆæœã€‚ä¹Ÿå°±æ˜¯åœ¨`watch_animation`å¹³è¡Œçš„åˆ†æ”¯ä¸ŠåŠ ä¸€ä¸ª`dummy`taskï¼Œå®ƒå•¥æ´»éƒ½ä¸å¹²ï¼š

```python
dummp_op = DummyOperator(
	task_id = &quot;dummy&quot;,
  dag = dag
)
do_homework_op &gt;&gt; check_hour_op &gt;&gt; [watch_animation_op, dummp_op]
watch_animation_op &gt;&gt; sleep_op
dummp_op &gt;&gt; sleep_op
```

è¿™ç§æ–¹å¼æ›´ç®€å•æ˜“æ‡‚ï¼Œä»£ä»·å°±æ˜¯ä¼šç¨ç¨å¢åŠ äº›ä»£ç ï¼Œå–œæ¬¢å“ªä¸ªå°±ä»è€…è§ä»äº†:smirk:ã€‚</content><author><name>jessychen</name></author><category term="Airflow" /><category term="CS" /><summary type="html">Airflow æ˜¯ Airbnb å…¬å¸å¼€æºçš„ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ, é€šè¿‡ä½¿ç”¨ Python å¼€å‘ DAG, éå¸¸æ–¹ä¾¿çš„è°ƒåº¦è®¡ç®—ä»»åŠ¡ã€‚</summary></entry></feed>